






    -- Generated by dbtvault.



WITH source_data AS (

    SELECT

    ORDERID,
    CUSTOMERID,
    SHIPPERID,
    PRODUCTID,
    ORDERDATE,
    SHIPDATE,
    SHIPADDRESS,
    SHIPCITY,
    SHIPREGION,
    SHIPPOSTALCODE,
    SHIPCOUNTRY,
    CREATE_TS,
    UPDATE_TS

    FROM DATAVAULTDEMO_DB.SS_RAW.raw_orders
),

derived_columns AS (

    SELECT

    ORDERID,
    CUSTOMERID,
    SHIPPERID,
    PRODUCTID,
    ORDERDATE,
    SHIPDATE,
    SHIPADDRESS,
    SHIPCITY,
    SHIPREGION,
    SHIPPOSTALCODE,
    SHIPCOUNTRY,
    CREATE_TS,
    UPDATE_TS,
    'TPCH-ORDERS' AS RECORD_SOURCE,
    CURRENT_TIMESTAMP() AS LOAD_DATE

    FROM source_data
),

hashed_columns AS (

    SELECT

    ORDERID,
    CUSTOMERID,
    SHIPPERID,
    PRODUCTID,
    ORDERDATE,
    SHIPDATE,
    SHIPADDRESS,
    SHIPCITY,
    SHIPREGION,
    SHIPPOSTALCODE,
    SHIPCOUNTRY,
    CREATE_TS,
    UPDATE_TS,
    RECORD_SOURCE,
    LOAD_DATE,

    CAST((MD5_BINARY(NULLIF(UPPER(TRIM(CAST(ORDERID AS VARCHAR))), ''))) AS BINARY(16)) AS ORDER_PK,
    CAST((MD5_BINARY(NULLIF(UPPER(TRIM(CAST(PRODUCTID AS VARCHAR))), ''))) AS BINARY(16)) AS PRODUCT_PK,
    CAST((MD5_BINARY(NULLIF(UPPER(TRIM(CAST(SHIPPERID AS VARCHAR))), ''))) AS BINARY(16)) AS SHIPPER_PK,
    CAST((MD5_BINARY(NULLIF(UPPER(TRIM(CAST(CUSTOMERID AS VARCHAR))), ''))) AS BINARY(16)) AS CUSTOMER_PK,
    CAST(MD5_BINARY(NULLIF(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(PRODUCTID AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(ORDERID AS VARCHAR))), ''), '^^')
    ), '^^||^^')) AS BINARY(16)) AS ORDER_PRODUCT_PK,
    CAST(MD5_BINARY(NULLIF(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(ORDERID AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(SHIPPERID AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(CUSTOMERID AS VARCHAR))), ''), '^^')
    ), '^^||^^||^^')) AS BINARY(16)) AS ORDER_SHIPPER_CUSTOMER_PK,
    CAST(MD5_BINARY(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(CUSTOMERID AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(ORDERDATE AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(ORDERID AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(PRODUCTID AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(SHIPADDRESS AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(SHIPCITY AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(SHIPCOUNTRY AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(SHIPDATE AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(SHIPPERID AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(SHIPPOSTALCODE AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(SHIPREGION AS VARCHAR))), ''), '^^')
    )) AS BINARY(16)) AS ORDER_HASHDIFF

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    ORDERID,
    CUSTOMERID,
    SHIPPERID,
    PRODUCTID,
    ORDERDATE,
    SHIPDATE,
    SHIPADDRESS,
    SHIPCITY,
    SHIPREGION,
    SHIPPOSTALCODE,
    SHIPCOUNTRY,
    CREATE_TS,
    UPDATE_TS,
    RECORD_SOURCE,
    LOAD_DATE,
    ORDER_PK,
    PRODUCT_PK,
    SHIPPER_PK,
    CUSTOMER_PK,
    ORDER_PRODUCT_PK,
    ORDER_SHIPPER_CUSTOMER_PK,
    ORDER_HASHDIFF

    FROM hashed_columns
)

SELECT * FROM columns_to_select