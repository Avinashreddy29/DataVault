






    -- Generated by dbtvault.



WITH source_data AS (

    SELECT

    PRODUCTID,
    PRODUCTNAME,
    SUPPLIERID,
    CATEGORYID,
    QUANTITYPERUNIT,
    UNITPRICE,
    UNITSINSTOCK,
    UNITSONORDER,
    REORDERLEVEL,
    CREATE_TS,
    UPDATE_TS

    FROM DATAVAULTDEMO_DB.SS_RAW.raw_products
),

derived_columns AS (

    SELECT

    PRODUCTID,
    PRODUCTNAME,
    SUPPLIERID,
    CATEGORYID,
    QUANTITYPERUNIT,
    UNITPRICE,
    UNITSINSTOCK,
    UNITSONORDER,
    REORDERLEVEL,
    CREATE_TS,
    UPDATE_TS,
    CATEGORYID AS CATEGORY,
    'TPCH-PRODUCTS' AS RECORD_SOURCE,
    CURRENT_TIMESTAMP() AS LOAD_DATE

    FROM source_data
),

hashed_columns AS (

    SELECT

    PRODUCTID,
    PRODUCTNAME,
    SUPPLIERID,
    CATEGORYID,
    QUANTITYPERUNIT,
    UNITPRICE,
    UNITSINSTOCK,
    UNITSONORDER,
    REORDERLEVEL,
    CREATE_TS,
    UPDATE_TS,
    CATEGORY,
    RECORD_SOURCE,
    LOAD_DATE,

    CAST((MD5_BINARY(NULLIF(UPPER(TRIM(CAST(PRODUCTID AS VARCHAR))), ''))) AS BINARY(16)) AS PRODUCT_PK,
    CAST((MD5_BINARY(NULLIF(UPPER(TRIM(CAST(SUPPLIERID AS VARCHAR))), ''))) AS BINARY(16)) AS SUPPLIER_PK,
    CAST(MD5_BINARY(NULLIF(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(PRODUCTID AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(SUPPLIERID AS VARCHAR))), ''), '^^')
    ), '^^||^^')) AS BINARY(16)) AS PRODUCT_SUPPLIER_PK,
    CAST(MD5_BINARY(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(CATEGORYID AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(PRODUCTID AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(PRODUCTNAME AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(QUANTITYPERUNIT AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(REORDERLEVEL AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(SUPPLIERID AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(UNITPRICE AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(UNITSINSTOCK AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(UNITSONORDER AS VARCHAR))), ''), '^^')
    )) AS BINARY(16)) AS PRODUCT_HASHDIFF

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    PRODUCTID,
    PRODUCTNAME,
    SUPPLIERID,
    CATEGORYID,
    QUANTITYPERUNIT,
    UNITPRICE,
    UNITSINSTOCK,
    UNITSONORDER,
    REORDERLEVEL,
    CREATE_TS,
    UPDATE_TS,
    CATEGORY,
    RECORD_SOURCE,
    LOAD_DATE,
    PRODUCT_PK,
    SUPPLIER_PK,
    PRODUCT_SUPPLIER_PK,
    PRODUCT_HASHDIFF

    FROM hashed_columns
)

SELECT * FROM columns_to_select