







    -- Generated by dbtvault.



WITH source_data AS (

    SELECT

    SUPPLIERID,
    COMPANYNAME,
    CONTACTNAME,
    CONTACTTITLE,
    ADDRESS,
    REGION,
    POSTALCODE,
    COUNTRY,
    CREATE_TS,
    UPDATE_TS

    FROM DATAVAULTDEMO_DB.SS_RAW.raw_suppliers
),

derived_columns AS (

    SELECT

    SUPPLIERID,
    COMPANYNAME,
    CONTACTNAME,
    CONTACTTITLE,
    ADDRESS,
    REGION,
    POSTALCODE,
    COUNTRY,
    CREATE_TS,
    UPDATE_TS,
    'TPCH-SUPPLIERS' AS RECORD_SOURCE,
    CURRENT_TIMESTAMP() AS LOAD_DATE

    FROM source_data
),

hashed_columns AS (

    SELECT

    SUPPLIERID,
    COMPANYNAME,
    CONTACTNAME,
    CONTACTTITLE,
    ADDRESS,
    REGION,
    POSTALCODE,
    COUNTRY,
    CREATE_TS,
    UPDATE_TS,
    RECORD_SOURCE,
    LOAD_DATE,

    CAST((MD5_BINARY(NULLIF(UPPER(TRIM(CAST(SUPPLIERID AS VARCHAR))), ''))) AS BINARY(16)) AS SUPPLIER_PK,
    CAST(MD5_BINARY(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(ADDRESS AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(COMPANYNAME AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(CONTACTNAME AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(CONTACTTITLE AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(COUNTRY AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(POSTALCODE AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(REGION AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(SUPPLIERID AS VARCHAR))), ''), '^^')
    )) AS BINARY(16)) AS SUPPLIER_HASHDIFF

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    SUPPLIERID,
    COMPANYNAME,
    CONTACTNAME,
    CONTACTTITLE,
    ADDRESS,
    REGION,
    POSTALCODE,
    COUNTRY,
    CREATE_TS,
    UPDATE_TS,
    RECORD_SOURCE,
    LOAD_DATE,
    SUPPLIER_PK,
    SUPPLIER_HASHDIFF

    FROM hashed_columns
)

SELECT * FROM columns_to_select