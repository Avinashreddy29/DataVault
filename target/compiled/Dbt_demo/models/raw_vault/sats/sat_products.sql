

-- Generated by dbtvault.

WITH source_data AS (
    SELECT a.PRODUCT_PK, a.PRODUCT_HASHDIFF, a.PRODUCTID, a.PRODUCTNAME, a.QUANTITYPERUNIT, a.UNITPRICE, a.CATEGORYID, a.UNITSINSTOCK, a.UNITSONORDER, a.REORDERLEVEL, a.LOAD_DATE, a.RECORD_SOURCE
    FROM DATAVAULTDEMO_DB.SS_STG.v_stg_products AS a
    WHERE __PERIOD_FILTER__
    
),

update_records AS (
    SELECT a.PRODUCT_PK, a.PRODUCT_HASHDIFF, a.PRODUCTID, a.PRODUCTNAME, a.QUANTITYPERUNIT, a.UNITPRICE, a.CATEGORYID, a.UNITSINSTOCK, a.UNITSONORDER, a.REORDERLEVEL, a.LOAD_DATE, a.RECORD_SOURCE
    FROM DATAVAULTDEMO_DB.SS_RAW_VLT.sat_products as a
    JOIN source_data as b
    ON a.PRODUCT_PK = b.PRODUCT_PK
),

latest_records AS (
    SELECT c.PRODUCT_PK, c.PRODUCT_HASHDIFF, c.LOAD_DATE,
           CASE WHEN RANK()
           OVER (PARTITION BY c.PRODUCT_PK
           ORDER BY c.LOAD_DATE DESC) = 1
    THEN 'Y' ELSE 'N' END AS latest
    FROM update_records as c
    QUALIFY latest = 'Y'
),

records_to_insert AS (
    SELECT DISTINCT e.PRODUCT_PK, e.PRODUCT_HASHDIFF, e.PRODUCTID, e.PRODUCTNAME, e.QUANTITYPERUNIT, e.UNITPRICE, e.CATEGORYID, e.UNITSINSTOCK, e.UNITSONORDER, e.REORDERLEVEL, e.LOAD_DATE, e.RECORD_SOURCE
    FROM source_data AS e
    LEFT JOIN latest_records
    ON latest_records.PRODUCT_HASHDIFF = e.PRODUCT_HASHDIFF
    WHERE latest_records.PRODUCT_HASHDIFF IS NULL
)

SELECT * FROM records_to_insert